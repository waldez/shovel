var ShovelClient=function(e){function __webpack_require__(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,__webpack_require__),n.l=!0,n.exports}var t={};return __webpack_require__.m=e,__webpack_require__.c=t,__webpack_require__.i=function(e){return e},__webpack_require__.d=function(e,t,r){__webpack_require__.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},__webpack_require__.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return __webpack_require__.d(t,"a",t),t},__webpack_require__.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=2)}([function(e,t,r){"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function getOfType(e,t){if((void 0===e?"undefined":o(e))!==t)throw new TypeError('Value "'+e+'" should be of type '+t+", but is of type "+(void 0===e?"undefined":o(e))+"!");return e}var n=function(){function defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&defineProperties(e.prototype,t),r&&defineProperties(e,r),e}}(),o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=r(4),a=r(3),u=a.MESSAGE_TYPE,s=function(){function Net(e){var t=this;_classCallCheck(this,Net);var r=getOfType(e,"object"),n=r.host,o=r.port,s=r.bodyParser,c=r.buildMetadata,f=r.onHandlerData;this.host=getOfType(n,"string"),this.port=getOfType(o,"string"),this.bodyParser=getOfType(s,"function"),this.buildMetadata=getOfType(c,"function"),this.onHandlerData=getOfType(f,"function");var l=new Map,p=new a.ConcurentIds,d=new i("ws://"+n+":"+o);d.onmessage=function(e){var r=a.extractHeader(e.data),n=r.type,o=r.id,i=r.rawData;switch(n){case u.REQUEST:try{var s=t.bodyParser(i);t.onHandlerData(s)}catch(e){}return;case u.RESPONSE:return void l.get(o)(i,200,null);case u.ERROR:return void l.get(o)(i,500,"Error vole!")}},this.readyPromise=new Promise(function(e,r){d.onopen=function(r){t.stop=function(){return d.close(1e3,'OK - Shovel client "stop" was called.')},t.request=function(e){return new Promise(function(r,n){var o=p.popId(),i=a.insertHeader(e,u.REQUEST,o);l.set(o,function(e,i,a){return l.delete(o),p.pushId(o),t.processResponse(r,n,e,200,null)}),d.send(i)})},e(t)}})}return n(Net,[{key:"processResponse",value:function(e,t,r,n,o){var i=r;if(200===n)try{Promise.resolve(this.bodyParser(r)).then(e).catch(t)}catch(e){t(e)}else{t({statusCode:n,statusMessage:o,response:i})}}},{key:"ready",get:function(){return this.readyPromise}}]),Net}();e.exports=s},function(e,t,r){"use strict";function isInheritable(e){return e.ctor||"function"==typeof e.instanceOf}function getNullStr(e){return"null"}function stringifyExtended(e,t){return'{"$$type":"'+e+'","$$data":'+t+"}"}function getTypeFromName(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:i)[e]}function getType(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:a,u=void 0===e?"undefined":n(e);if(null===e||"undefined"==u)return r.Undefined;if("object"==u){var s=Object.getPrototypeOf(e),c=r[s.constructor.name];return c&&c.ctor&&e instanceof c.ctor?c:o.find(function(r){return r.instanceOf&&r.instanceOf(e,t)||r.ctor&&e instanceof r.ctor})||r.Object}return r[Object.getPrototypeOf(e).constructor.name]}function arrayStringify(e,t){for(var r="",n="",o=0;o<e.length;o++){var i=e[o];n+=r+stringify.call(this,i,t),r=","}return"["+n+"]"}function objectStringify(e,t){var r="",n="";for(var o in e)if(e.hasOwnProperty(o)){var i=e[o];if(void 0===i)continue;n+=r+JSON.stringify(o)+":"+stringify.call(this,i,t),r=","}return"{"+n+"}"}function decode(e,t){return parse.call(this,e,t)}function encode(e,t){return stringify.call(this,e,t)}function stringify(e,t){var r=getType(e,t,this.handlers,this.inheritables);return r.stringify?r.stringify.call(this,e,t):JSON.stringify(e)}function parse(e,t){var r=this;return JSON.parse(e,function(e,n){if(n&&n.$$type&&n.$$data){var o=getTypeFromName(n.$$type,r.handlers);return o&&o.parse?o.parse(n.$$data,t):n}return n})}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function sliceIterator(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw i}}return r}return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return sliceIterator(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i={Undefined:{name:"Undefined",stringify:getNullStr},Boolean:{name:"Boolean"},Number:{name:"Number"},String:{name:"String"},Object:{name:"Object",stringify:objectStringify},Function:{name:"Function",ctor:Function,stringify:getNullStr},Date:{name:"Date",ctor:Date,stringify:function(e){return stringifyExtended("Date",'"'+e.toISOString()+'"')},parse:function(e){return new Date(e)}},RegExp:{name:"RegExp",ctor:RegExp,stringify:function(e){return stringifyExtended("RegExp",'["'+e.source+'","'+e.flags+'"]')},parse:function(e){var t=o(e,2),r=t[0],n=t[1];return new RegExp(r,n)}},Error:{name:"Error",ctor:Error},Array:{name:"Array",ctor:Array,stringify:arrayStringify}},a=Object.keys(i).map(function(e){return i[e]}).filter(isInheritable),u=function(e){var t=e.handlers;for(var r in t)t.hasOwnProperty(r)&&function(){var e=t[r];if("function"==typeof e.stringify){var n=e.stringify.bind(e);e.stringify=function(t,r){return stringifyExtended(e.name,n(t,r))}}}();this.handlers=Object.assign({},i,t),this.inheritables=Object.keys(t).map(function(e){return t[e]}).filter(isInheritable)},s={decode:decode,encode:encode,stringify:stringify,parse:parse};Object.assign(u,s),u.prototype=s,e.exports=u},function(module,exports,__webpack_require__){"use strict";function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function step(n,o){try{var i=t[n](o),a=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(a).then(function(e){step("next",e)},function(e){step("throw",e)});e(a)}return step("next")})}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function getUid(){var e=(new Date).getTime(),t=1e9*Math.random()|0,r=t%15;return e.toString(16)+t.toString(16)+r.toString(16)}function _w(e){if(e instanceof Wrapper)return e;throw Error("Not a Wrapper instance")}function createWrapperClass(descriptor,typeName,typeHash,shovel){function getProperty(e,t){return shovel(e[UID_KEY],ACTIONS.get,t)}function setProperty(e,t,r){return shovel(e[UID_KEY],ACTIONS.set,t,r)}function callFunction(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),o=2;o<r;o++)n[o-2]=arguments[o];return shovel(e[UID_KEY],ACTIONS.call,t,n)}var wrapperClassName=typeName+"Wrapper",dummy=_defineProperty({},wrapperClassName,function(e){this[UID_KEY]=e}),classConstructor=dummy[wrapperClassName],proto=new Wrapper(typeName,typeHash),_loop=function _loop(key){var _descriptor$key=descriptor[key],type=_descriptor$key.type,parameters=_descriptor$key.parameters;if("function"==type){var joinedPars=parameters.join(),pars=""!=joinedPars.length?","+joinedPars:"",body="(function("+joinedPars+") { return callFunction(this,'"+key+"'"+pars+"); })",fn=eval(body);proto[""+key]=fn}else proto[""+key]=function(e){return void 0===e?getProperty(this,key):setProperty(this,key,e)}};for(var key in descriptor)_loop(key);return classConstructor.prototype=proto,classConstructor.prototype.constructor=classConstructor,classConstructor}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){function sliceIterator(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw i}}return r}return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return sliceIterator(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&defineProperties(e.prototype,t),r&&defineProperties(e,r),e}}(),JSONE=__webpack_require__(1),Net=__webpack_require__(0),UID_KEY=Symbol("uid"),TYPE_KEY=Symbol("type"),ACTIONS=Object.freeze({list:"list",call:"call",get:"get",set:"set"}),FunctionHandler=function(){function FunctionHandler(e){if(_classCallCheck(this,FunctionHandler),"function"!=typeof e)throw new TypeError("FunctionHandler constructor parameter is not a function!");var t=getUid();this.call=function(t){try{return Promise.resolve(e.apply(void 0,_toConsumableArray(t)))}catch(e){return Promise.reject(e)}},Object.defineProperties(this,{id:{get:function(){return t}}})}return _createClass(FunctionHandler,null,[{key:"stringify",value:function(e){return'{"id":"'+e.id+'"}'}}]),FunctionHandler}(),Wrapper=function(e,t){Object.defineProperties(this,_defineProperty({},TYPE_KEY,{get:function(){return{typeName:e,typeHash:t}}}))};Wrapper.isWrapper=function(e){return e instanceof Wrapper},Wrapper.getTypeInfo=function(e){return _w(e)[TYPE_KEY]},Wrapper.getUid=function(e){return _w(e)[UID_KEY]},Wrapper.equals=function(e,t){return _w(e)[UID_KEY]==_w(t)[UID_KEY]},Wrapper.stringify=function(e){var t=_w(e);return'{"uid":'+t[UID_KEY]+',"typeHash":'+t[TYPE_KEY].typeHash+"}"};var ShovelClient=function(){function ShovelClient(e){function addWrapperClass(e,t,r){var n=s.get(r);return n||(n=createWrapperClass(e,t,r,a),s.set(r,{wrapper:n,descriptor:e,typeName:t})),n}function addInstance(e,t){var r=c.get(e);return r||(r=new t(e),c.set(e,r)),r}function buildMetadata(){return{dataUuid:p,globalDataUuid:d}}function Metadata(e){processMetadata(e)}function processMetadata(e,t){var r=t?[]:null;if(e.dataUuid!=p||e.globalDataUuid!=d){for(var n in e.metadata)!function(n){var o=e.metadata[n],i=o.descriptor,a=o.typeName,u=o.instances,s=addWrapperClass(i,a,Number(n));u.forEach(function(e){addInstance(e,s)}),t&&r.push({typeName:a,instances:u})}(n);for(var o in e.globals)u.set(o,e.globals[o]);p=e.dataUuid,d=e.globalDataUuid}return r}function onHandlerData(e){var t=this;Array.isArray(e)&&e.forEach(function(e){var r=t.getHandler(e.id);if(r){Promise.resolve(r.call(e.data))}})}function shovel(e,t,r,n){var o=[buildMetadata(),{action:t,path:e,field:r,data:n}];return b.request(h.encode(o)).then(function(t){var r=_slicedToArray(t,2);r[0];return r[1][e].data}).catch(function(e){return Promise.reject(e)})}var t=this,r=e.serviceHost,n=void 0===r?"localhost":r,o=e.servicePort,i=void 0===o?"31415":o;_classCallCheck(this,ShovelClient);var a=shovel.bind(this),u=new Map,s=new Map,c=new Map,f=new Map,l=new WeakMap,p=0,d=0,y={Metadata:{name:"Metadata",ctor:Metadata.prototype.constructor,parse:function(e){return Metadata(e)}},FunctionHandler:{name:"FunctionHandler",ctor:FunctionHandler.prototype.constructor,stringify:FunctionHandler.stringify,parse:function(e){var t=e.id,r=e.args,n=(e.responseId,handlers.get(t));return n&&n.call(r),n}},Wrapper:{name:"Wrapper",ctor:Wrapper,stringify:Wrapper.stringify,parse:function(e){var t=e.uid,r=e.typeHash,n=c.get(t);if(n)return n;var o=s.get(r);return o?addInstance(t,o.wrapper):null}}},h=new JSONE({handlers:y}),v=h.decode.bind(h),b=new Net({host:n,port:i,bodyParser:v,buildMetadata:buildMetadata,onHandlerData:onHandlerData.bind(this)});this.getServiceInfo=function(){return{serviceHost:n,servicePort:i}},this.stop=function(){return b.stop()},this.registerHandler=function(e){if("function"!=typeof e)throw new TypeError("Trying to register "+(void 0===e?"undefined":_typeof(e))+" instead of function!");var t=l.get(e);return t||(t=new FunctionHandler(e),f.set(t.id,t),l.set(e,t),t)},this.getHandler=function(e){return f.get(e)||l.get(e)},this.unregisterHandler=function(e){switch(void 0===e?"undefined":_typeof(e)){case"function":throw new Error("Not implemented yet!");case"string":break;case"object":if(!(e instanceof FunctionHandler))throw new TypeError("Trying to unregister handler, using invalid handler identifier!");e=e.id;break;default:throw new TypeError("Trying to unregister handler, using invalid handler identifier!")}return f.delete(e)},this.initialize=function(){return b.ready.then(t.list.bind(t,!0)).then(function(){return t})},this.get=function(e){var t="number"==typeof e?e:u.get(e);return c.get(t)},this.list=function(){if(arguments.length>0&&void 0!==arguments[0]&&arguments[0]){var e=[buildMetadata(),{action:ACTIONS.list}];return b.request(h.encode(e))}var t=new Map;return c.forEach(function(e,r){var n=e[TYPE_KEY],o=n.typeName,i=n.typeHash,a=t.get(i)||{typeName:o,instances:[]};a.instances.push(r),t.set(i,a)}),Array.from(t.values())}}return _createClass(ShovelClient,null,[{key:"create",value:function(){function create(){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function _callee(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e=new ShovelClient(t),n.next=3,r?e.initialize():e;case 3:return n.abrupt("return",n.sent);case 4:case"end":return n.stop()}},_callee,this)}));return create}()},{key:"Wrapper",get:function(){return Wrapper}}]),ShovelClient}();module.exports=ShovelClient.create},function(e,t,r){"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var n=function(){function sliceIterator(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw i}}return r}return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return sliceIterator(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&defineProperties(e.prototype,t),r&&defineProperties(e,r),e}}(),i=Object.freeze({REQUEST:"q",RESPONSE:"s",ERROR:"e"}),a=function(){function ConcurentIds(){_classCallCheck(this,ConcurentIds),this.used=new Set,this.next=0}return o(ConcurentIds,[{key:"popId",value:function(){var e=this.next;for(this.used.add(e);this.used.has(++this.next););return e}},{key:"pushId",value:function(e){this.next=this.next>e?e:this.next,this.used.delete(e)}}]),ConcurentIds}();e.exports={extractHeader:function(e){var t=e.split(":",2),r=n(t,2),o=r[0],i=r[1];return{type:o[o.length-1],id:parseInt(o),rawData:i}},insertHeader:function(e,t,r){return r+t+":"+e},ConcurentIds:a,MESSAGE_TYPE:i}},function(e,t,r){(function(t){var r=null;"undefined"!=typeof WebSocket?r=WebSocket:"undefined"!=typeof MozWebSocket?r=MozWebSocket:void 0!==t?r=t.WebSocket||t.MozWebSocket:"undefined"!=typeof window?r=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(r=self.WebSocket||self.MozWebSocket),e.exports=r}).call(t,r(5))},function(e,t){var r;r=function(){return this}();try{r=r||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(r=window)}e.exports=r}]);