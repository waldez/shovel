var ShovelClient=function(e){function __webpack_require__(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,__webpack_require__),n.l=!0,n.exports}var r={};return __webpack_require__.m=e,__webpack_require__.c=r,__webpack_require__.i=function(e){return e},__webpack_require__.d=function(e,r,t){__webpack_require__.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:t})},__webpack_require__.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return __webpack_require__.d(r,"a",r),r},__webpack_require__.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=1)}([function(module,exports,__webpack_require__){"use strict";function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function getUid(){var e=(new Date).getTime(),r=1e9*Math.random()|0,t=r%15;return e.toString(16)+r.toString(16)+t.toString(16)}function _w(e){if(e instanceof Wrapper)return e;throw Error("Not a Wrapper instance")}function createWrapperClass(descriptor,typeName,typeHash,shovel){function getProperty(e,r){return shovel(e[UID_KEY],ACTIONS.get,r)}function setProperty(e,r,t){return shovel(e[UID_KEY],ACTIONS.set,r,t)}function callFunction(e,r){for(var t=arguments.length,n=Array(t>2?t-2:0),o=2;o<t;o++)n[o-2]=arguments[o];return shovel(e[UID_KEY],ACTIONS.call,r,n)}var wrapperClassName=typeName+"Wrapper",dummy=_defineProperty({},wrapperClassName,function(e){this[UID_KEY]=e}),classConstructor=dummy[wrapperClassName],proto=new Wrapper(typeName,typeHash);for(var key in descriptor){var _descriptor$key=descriptor[key],type=_descriptor$key.type,parameters=_descriptor$key.parameters;if("function"==type){var joinedPars=parameters.join(),pars=""!=joinedPars.length?","+joinedPars:"",body="(function("+joinedPars+") { return callFunction(this,'"+key+"'"+pars+"); })",fn=eval(body);proto[""+key]=fn}else proto[""+key]=function(e){return void 0===e?getProperty(this,key):setProperty(this,key,e)}}return classConstructor.prototype=proto,classConstructor.prototype.constructor=classConstructor,classConstructor}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){function sliceIterator(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}return t}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return sliceIterator(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,r,t){return r&&defineProperties(e.prototype,r),t&&defineProperties(e,t),e}}(),JSONE=__webpack_require__(2),HOOK_TIMEOUT=25e3,UID_KEY=Symbol("uid"),TYPE_KEY=Symbol("type"),ACTIONS=Object.freeze({list:"list",call:"call",get:"get",set:"set"}),url="/",OK_STATUSES=[200],DEFAULT_BODY_PARSER=JSON.parse.bind(JSON),isOkStatus=function(e){return OK_STATUSES.indexOf(e)>-1},processResponse=function(e,r,t,n,o){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:DEFAULT_BODY_PARSER,a=t;if(isOkStatus(n))try{Promise.resolve(i(t)).then(e).catch(r)}catch(e){r(e)}else{r({statusCode:n,statusMessage:o,response:a})}},FunctionHandler=function(){function FunctionHandler(e){if(_classCallCheck(this,FunctionHandler),"function"!=typeof e)throw new TypeError("FunctionHandler constructor parameter is not a function!");var r=getUid();this.call=function(r){try{var t=e.apply(void 0,_toConsumableArray(r))}catch(e){return Promise.reject(e)}return Promise.resolve(t)},Object.defineProperties(this,{id:{get:function(){return r}}})}return _createClass(FunctionHandler,null,[{key:"stringify",value:function(e){return'{"id":"'+e.id+'"}'}}]),FunctionHandler}(),Wrapper=function(e,r){Object.defineProperties(this,_defineProperty({},TYPE_KEY,{get:function(){return{typeName:e,typeHash:r}}}))};Wrapper.isWrapper=function(e){return e instanceof Wrapper},Wrapper.getTypeInfo=function(e){return _w(e)[TYPE_KEY]},Wrapper.getUid=function(e){return _w(e)[UID_KEY]},Wrapper.equals=function(e,r){return _w(e)[UID_KEY]==_w(r)[UID_KEY]},Wrapper.stringify=function(e){var r=_w(e);return'{"uid":'+r[UID_KEY]+',"typeHash":'+r[TYPE_KEY].typeHash+"}"};var ShovelClient=function(){function ShovelClient(e){function boundRequest(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments[1];e.host=n,e.port=i;var t={"x-shovel-session":s()};return a(processResponse,e,r,t)}function addWrapperClass(e,r,t){var n=c.get(t);return n||(n=createWrapperClass(e,r,t,u),c.set(t,{wrapper:n,descriptor:e,typeName:r})),n}function addInstance(e,r){var t=f.get(e);return t||(t=new r(e),f.set(e,t)),t}function abortForeverHook(){g=null,v&&(v.abort(),v=null),nextTickForeverHook()}function nextTickForeverHook(){setTimeout(m,0)}function buildMetadata(){return{dataUuid:d,globalDataUuid:y}}function processMetadata(e,r){var t=r?[]:null;if(e.dataUuid!=d||e.globalDataUuid!=y){for(var n in e.metadata)!function(n){var o=e.metadata[n],i=o.descriptor,a=o.typeName,s=o.instances,u=addWrapperClass(i,a,Number(n));s.forEach(function(e){addInstance(e,u)}),r&&t.push({typeName:a,instances:s})}(n);d=e.dataUuid,y=e.globalDataUuid}}function shovel(e,r,t,n){var o=_.decode.bind(_),i=[buildMetadata(),{action:r,path:e,field:t,data:n}];return boundRequest({method:"POST",path:url,bodyParser:o},_.encode(i)).then(function(r){var t=_slicedToArray(r,2),n=t[0],o=t[1];return processMetadata(n),o[e].data}).catch(function(e){return Promise.reject(e)})}var r=this,t=e.serviceHost,n=void 0===t?"localhost":t,o=e.servicePort,i=void 0===o?"31415":o,a=e.request,s=e.getSessionId;_classCallCheck(this,ShovelClient);var u=shovel.bind(this),c=new Map,f=new Map,l=new Map,p=new WeakMap,d=0,y=0,h={FunctionHandler:{name:"FunctionHandler",ctor:FunctionHandler.prototype.constructor,stringify:FunctionHandler.stringify,parse:function(e){var r=e.id,t=e.args,n=(e.responseId,handlers.get(r));return n&&n.call(t),n}},Wrapper:{name:"Wrapper",ctor:Wrapper,stringify:Wrapper.stringify,parse:function(e){var r=e.uid,t=e.typeHash,n=f.get(r);if(n)return n;var o=c.get(t);return o?addInstance(r,o.wrapper):null}}},v=null,g=null,_=new JSONE({handlers:h}),b=_.decode.bind(_),m=function(){clearTimeout(g),g=null,v=boundRequest({method:"POST",path:url+"foreverhook",bodyParser:b},[buildMetadata()]),v.then(function(e){v&&(v=null,Array.isArray(e)&&e.forEach(function(e){var t=r.getHandler(e.id);if(t){Promise.resolve(t.call(e.data))}})),nextTickForeverHook()},function(e){"ECONNRESET"===e.code||'"aborted"'===e.response||console.log("Error occured on forever hook:\n",e),v=null}),g=setTimeout(abortForeverHook,HOOK_TIMEOUT)};this.getServiceInfo=function(){return{serviceHost:n,servicePort:i}},this.registerHandler=function(e){if("function"!=typeof e)throw new TypeError("Trying to register "+(void 0===e?"undefined":_typeof(e))+" instead of function!");var r=p.get(e);return r||(r=new FunctionHandler(e),l.set(r.id,r),p.set(e,r),r)},this.getHandler=function(e){return l.get(e)||p.get(e)},this.unregisterHandler=function(e){switch(void 0===e?"undefined":_typeof(e)){case"function":throw new Error("Not implemented yet!");case"string":break;case"object":if(!(e instanceof FunctionHandler))throw new TypeError("Trying to unregister handler, using invalid handler identifier!");e=e.id;break;default:throw new TypeError("Trying to unregister handler, using invalid handler identifier!")}return l.delete(e)},this.initialize=function(){return m(),r.list(!0).then(function(){return r})},this.get=function(e){return f.get(e)},this.list=function(){if(arguments.length>0&&void 0!==arguments[0]&&arguments[0]){var e=[buildMetadata(),{action:ACTIONS.list}];return boundRequest({method:"POST",path:url},e).then(function(e){var r=_slicedToArray(e,2),t=r[0];return r[1],processMetadata(t,!0)})}var r=new Map;return f.forEach(function(e,t){var n=e[TYPE_KEY],o=n.typeName,i=n.typeHash,a=r.get(i)||{typeName:o,instances:[]};a.instances.push(t),r.set(i,a)}),Array.from(r.values())}}return _createClass(ShovelClient,null,[{key:"create",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=t.serviceHost,o=t.servicePort,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=new ShovelClient({serviceHost:n,servicePort:o,request:e,getSessionId:r});return i?a.initialize():a}},{key:"generateSessionId",value:function(){return getUid()}},{key:"Wrapper",get:function(){return Wrapper}}]),ShovelClient}();module.exports=ShovelClient},function(e,r,t){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=t(0);if("object"!=n(window.sessionStorage))throw new Error("Incompatible client for Shovel! Unsupported window.sessionStorage.");var i=function(){var e=window.sessionStorage.getItem("shovelSessionId");return e||(e=o.generateSessionId(),window.sessionStorage.setItem("shovelSessionId",e)),e},a=function(e,r,t,o){var i=r.method,a=void 0===i?"POST":i,s=r.port,u=r.host,c=r.path,f=void 0===c?"/":c,l=r.bodyParser,p=void 0,d=new Promise(function(r,i){if(t="object"===(void 0===t?"undefined":n(t))?JSON.stringify(t):t,p=new XMLHttpRequest,p.error=function(e){i({state:p.readyState,status:p.status,response:p.responseText,error:e})},p.onreadystatechange=function(){p.readyState===XMLHttpRequest.DONE&&e(r,i,p.responseText,p.status,void 0,l)},p.open(a,"http://"+u+":"+s+f,!0),"object"==(void 0===o?"undefined":n(o)))for(var c in o)o.hasOwnProperty(c)&&p.setRequestHeader(c,o[c])});return d.abort=function(){return d.aborted=!0,p.abort(),d},p.send(t),d};e.exports=o.create.bind(null,a,i)},function(e,r,t){"use strict";function isInheritable(e){return e.ctor||"function"==typeof e.instanceOf}function getNullStr(e){return"null"}function stringifyExtended(e,r){return'{"$$type":"'+e+'","$$data":'+r+"}"}function getTypeFromName(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:i)[e]}function getType(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:a,s=void 0===e?"undefined":n(e);if(null===e||"undefined"==s)return t.Undefined;if("object"==s){var u=Object.getPrototypeOf(e),c=t[u.constructor.name];return c&&c.ctor&&e instanceof c.ctor?c:o.find(function(t){return t.instanceOf&&t.instanceOf(e,r)||t.ctor&&e instanceof t.ctor})||t.Object}return t[Object.getPrototypeOf(e).constructor.name]}function arrayStringify(e,r){for(var t="",n="",o=0;o<e.length;o++){var i=e[o];n+=t+stringify.call(this,i,r),t=","}return"["+n+"]"}function objectStringify(e,r){var t="",n="";for(var o in e)if(e.hasOwnProperty(o)){var i=e[o];if(void 0===i)continue;n+=t+JSON.stringify(o)+":"+stringify.call(this,i,r),t=","}return"{"+n+"}"}function decode(e,r){return parse.call(this,e,r)}function encode(e,r){return stringify.call(this,e,r)}function stringify(e,r){var t=getType(e,r,this.handlers,this.inheritables);return t.stringify?t.stringify.call(this,e,r):JSON.stringify(e)}function parse(e,r){var t=this;return JSON.parse(e,function(e,n){if(n&&n.$$type&&n.$$data){var o=getTypeFromName(n.$$type,t.handlers);return o&&o.parse?o.parse(n.$$data,r):n}return n})}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function sliceIterator(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}return t}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return sliceIterator(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i={Undefined:{name:"Undefined",stringify:getNullStr},Boolean:{name:"Boolean"},Number:{name:"Number"},String:{name:"String"},Object:{name:"Object",stringify:objectStringify},Function:{name:"Function",ctor:Function,stringify:getNullStr},Date:{name:"Date",ctor:Date,stringify:function(e){return stringifyExtended("Date",'"'+e.toISOString()+'"')},parse:function(e){return new Date(e)}},RegExp:{name:"RegExp",ctor:RegExp,stringify:function(e){return stringifyExtended("RegExp",'["'+e.source+'","'+e.flags+'"]')},parse:function(e){var r=o(e,2),t=r[0],n=r[1];return new RegExp(t,n)}},Error:{name:"Error",ctor:Error},Array:{name:"Array",ctor:Array,stringify:arrayStringify}},a=Object.keys(i).map(function(e){return i[e]}).filter(isInheritable),s=function(e){var r=e.handlers;for(var t in r)r.hasOwnProperty(t)&&function(){var e=r[t];if("function"==typeof e.stringify){var n=e.stringify.bind(e);e.stringify=function(r,t){return stringifyExtended(e.name,n(r,t))}}}();this.handlers=Object.assign({},i,r),this.inheritables=Object.keys(r).map(function(e){return r[e]}).filter(isInheritable)},u={decode:decode,encode:encode,stringify:stringify,parse:parse};Object.assign(s,u),s.prototype=u,e.exports=s}]);